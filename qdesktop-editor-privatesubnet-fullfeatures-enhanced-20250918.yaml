AWSTemplateFormatVersion: 2010-09-09
Description: Create an QDesktop Editor instance in private subnet with ALL original features preserved. Version 1.0.0

Parameters:
  CodeEditorUser:
    Type: String
    Description: UserName for QDesktop Editor
    Default: participant
  InstanceName:
    Type: String
    Description: QDesktop Editor EC2 instance name
    Default: QDesktopEditor-Privatesubnet-Enhanced
  InstanceVolumeSize:
    Type: Number
    Description: QDesktop Editor EC2 instance volume size in GB
    Default: 40
  InstanceType:
    Description: QDesktop Editor EC2 instance type
    Type: String
    Default: t4g.medium
  InstanceOperatingSystem:
    Description: QDesktop Editor EC2 operating system
    Type: String
    Default: AmazonLinux-2023
    AllowedValues: ['AmazonLinux-2023', 'Ubuntu-22', 'Ubuntu-24']
  HomeFolder:
    Type: String
    Description: Folder to open in QDesktop Editor
    Default: /workshop
  DevServerBasePath:
    Type: String
    Description: Base path for the application to be added to Nginx sites-available list
    Default: app
  DevServerPort:
    Type: Number
    Description: Port for the DevServer
    Default: 8081
  RepoUrl:
    Description: Remote repo URL to clone. To not clone a remote repo, leave blank
    Type: String
    Default: ''
  AssetZipS3Path:
    Description: S3 path holding the asset zip file to be copied into the home folder. To not include any assets, leave blank
    Type: String
    Default: ''
  BranchZipS3Path:
    Description: S3 path holding the branches zip file to be checked into the git repo, with each folder being a branch. The content of each folder will added as under a branch, with the folder name being used as the branch name. To leave the empty, leave blank
    Type: String
    Default: ''
  FolderZipS3Path:
    Description: S3 path holding the folder zip file, with each folder being a subfolder of the home directory. Each folder will have its own local git repo. To not include any folders, leave blank
    Type: String
    Default: ''
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC ID for deployment
  PrivateSubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: Private subnet ID for EC2 instance
  VpcCidr:
    Type: String
    Description: VPC CIDR for security group rules
    Default: 0.0.0.0/0

Conditions:
  IsAL2023: !Equals [!Ref InstanceOperatingSystem, 'AmazonLinux-2023']
  IsGraviton: !Not [
    !Equals [
      !Select [0, !Split ['g', !Select [0, !Split ['.', !Ref InstanceType]]]],
      !Select [0, !Split ['.', !Ref InstanceType]]
    ]
  ]

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Instance Configuration
        Parameters:
          - InstanceName
          - InstanceVolumeSize
          - InstanceType
          - InstanceOperatingSystem
      - Label:
          default: Network Configuration
        Parameters:
          - VpcId
          - PrivateSubnetId
          - VpcCidr
      - Label:
          default: QDesktop Editor Configuration
        Parameters:
          - CodeEditorUser
          - HomeFolder
          - DevServerBasePath
          - DevServerPort
          - RepoUrl
          - AssetZipS3Path
          - BranchZipS3Path
          - FolderZipS3Path
    ParameterLabels:
      CodeEditorUser:
        default: QDesktop Editor user name
      InstanceName:
        default: Instance name
      InstanceVolumeSize:
        default: Instance volume size
      InstanceType:
        default: Instance type
      InstanceOperatingSystem:
        default: Instance operating system
      VpcId:
        default: VPC ID
      PrivateSubnetId:
        default: Private Subnet ID
      VpcCidr:
        default: VPC CIDR
      HomeFolder:
        default: QDesktop Editor home folder
      DevServerBasePath:
        default: Application base path
      DevServerPort:
        default: Application port
      RepoUrl:
        default: Git repo URL
      AssetZipS3Path:
        default: Asset file S3 path
      BranchZipS3Path:
        default: Branch file S3 path
      FolderZipS3Path:
        default: Folder file S3 path

Mappings:
  ArmImage:
    Ubuntu-22:
      ImageId: '{{resolve:ssm:/aws/service/canonical/ubuntu/server/jammy/stable/current/arm64/hvm/ebs-gp2/ami-id}}'
    Ubuntu-24:
      ImageId: '{{resolve:ssm:/aws/service/canonical/ubuntu/server/noble/stable/current/arm64/hvm/ebs-gp3/ami-id}}'
    AmazonLinux-2023:
      ImageId: '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-arm64}}'
  AmdImage:
    Ubuntu-22:
      ImageId: '{{resolve:ssm:/aws/service/canonical/ubuntu/server/jammy/stable/current/amd64/hvm/ebs-gp2/ami-id}}'
    Ubuntu-24:
      ImageId: '{{resolve:ssm:/aws/service/canonical/ubuntu/server/noble/stable/current/amd64/hvm/ebs-gp3/ami-id}}'
    AmazonLinux-2023:
      ImageId: '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}'

Resources:
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security Group for QDesktop Editor - VPC internal access only
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - Description: Allow QDesktop Editor access from VPC
          IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: !Ref VpcCidr

        - Description: Allow amazon-q-web-ui access from VPC
          IpProtocol: tcp
          FromPort: 3000
          ToPort: 3000
          CidrIp: !Ref VpcCidr
        - Description: Allow amazon-q-cli-api access from VPC
          IpProtocol: tcp
          FromPort: 3030
          ToPort: 3030
          CidrIp: !Ref VpcCidr

        - Description: Allow Dev Server access from VPC
          IpProtocol: tcp
          FromPort: !Ref DevServerPort
          ToPort: !Ref DevServerPort
          CidrIp: !Ref VpcCidr
      SecurityGroupEgress:
        - Description: Allow all outbound traffic
          IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-SecurityGroup

  CodeEditorSecret:
    Type: AWS::SecretsManager::Secret
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Name: !Sub
      - ${InstanceName}-${RandomGUID}
      - RandomGUID: !Select [0, !Split ['-', !Select [2, !Split ['/', !Ref AWS::StackId ]]]]
      Description: QDesktop Editor user details
      GenerateSecretString:
        PasswordLength: 16
        SecretStringTemplate: !Sub '{"username":"${CodeEditorUser}"}'
        GenerateStringKey: 'password'
        ExcludePunctuation: true

  SecretPlaintextLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: !Sub lambda.${AWS::URLSuffix}
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Sub arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: AwsSecretsManager
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref CodeEditorSecret

  SecretPlaintextLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: Return the value of the secret
      Handler: index.lambda_handler
      Runtime: python3.13
      MemorySize: 128
      Timeout: 10
      Architectures:
        - arm64
      Role: !GetAtt SecretPlaintextLambdaRole.Arn
      Code:
        ZipFile: |
          import boto3
          import json
          import cfnresponse
          import logging

          logger = logging.getLogger()
          logger.setLevel(logging.INFO)

          def is_valid_json(json_string):
              logger.debug(f'Calling is_valid_jason:{json_string}')
              try:
                  json.loads(json_string)
                  logger.info(f'Secret is in json format')
                  return True
              except json.JSONDecodeError:
                  logger.info(f'Secret is in string format')
                  return False

          def lambda_handler(event, context):
              logger.debug(f'event: {event}')
              logger.debug(f'context: {context}')
              try:
                  if event['RequestType'] == 'Delete':
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData={}, reason='No action to take')
                  else:
                      resource_properties = event['ResourceProperties']
                      secret_name = resource_properties['SecretArn']
                      secrets_mgr = boto3.client('secretsmanager')

                      logger.info(f'Getting secret from {secret_name}')

                      secret = secrets_mgr.get_secret_value(SecretId = secret_name)
                      logger.debug(f'secret: {secret}')
                      secret_value = secret['SecretString']

                      responseData = {}
                      if is_valid_json(secret_value):
                          responseData = secret_value
                      else:
                          responseData = {'secret': secret_value}
                      logger.debug(f'responseData: {responseData}')
                      logger.debug(f'type(responseData): {type(responseData)}')
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData=json.loads(responseData), reason='OK', noEcho=True)
              except Exception as e:
                  logger.error(e)
                  cfnresponse.send(event, context, cfnresponse.FAILED, responseData={}, reason=str(e))

  SecretPlaintext:
    Type: Custom::SecretPlaintextLambda
    Properties:
      ServiceToken: !GetAtt SecretPlaintextLambda.Arn
      ServiceTimeout: 15
      SecretArn: !Ref CodeEditorSecret
  CodeEditorSSMDoc:
    Type: AWS::SSM::Document
    Properties:
      DocumentType: Command
      Content:
        schemaVersion: '2.2'
        description: Bootstrap QDesktop Editor instance - Private deployment with full features
        parameters:
          LinuxFlavor:
            type: String
            default: 'al2023'
          CodeEditorPassword:
            type: String
            default: !Ref AWS::StackId
        mainSteps:
          - name: InstallCloudWatchAgent
            action: aws:configurePackage
            inputs:
              name: AmazonCloudWatchAgent
              action: Install
          - name: ConfigureCloudWatchAgent
            action: aws:runDocument
            inputs:
              documentType: SSMDocument
              documentPath: AmazonCloudWatch-ManageAgent
              documentParameters:
                action: configure
                mode: ec2
                optionalConfigurationSource: default
                optionalRestart: 'yes'
          - name: InstallAptPackagesApt
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - ubuntu
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - set -euo pipefail
                - dpkg --configure -a
                - apt-get -q update && DEBIAN_FRONTEND=noninteractive apt-get install -y -q apt-utils
                - apt-get -q update && DEBIAN_FRONTEND=noninteractive apt-get install -y -q needrestart unattended-upgrades
                - sed -i 's/#$nrconf{kernelhints} = -1;/$nrconf{kernelhints} = 0;/' /etc/needrestart/needrestart.conf
                - sed -i 's/#$nrconf{verbosity} = 2;/$nrconf{verbosity} = 0;/' /etc/needrestart/needrestart.conf
                - sed -i "s/#\$nrconf{restart} = 'i';/\$nrconf{restart} = 'a';/" /etc/needrestart/needrestart.conf
                - echo "Apt helper packages added. Checking configuration"
                - cat /etc/needrestart/needrestart.conf
          - name: InstallBasePackagesDnf
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - al2023
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - set -euo pipefail
                - dnf install -y --allowerasing curl gnupg whois argon2 unzip openssl jq
          - name: InstallBasePackagesApt
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - ubuntu
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - set -euo pipefail
                - dpkg --configure -a
                - apt-get -q update && DEBIAN_FRONTEND=noninteractive apt-get install -y -q curl gnupg whois argon2 unzip openssl locales locales-all apt-transport-https ca-certificates software-properties-common jq
          - name: AddUserDnf
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - al2023
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - !Sub |
                  echo 'Adding user: ${CodeEditorUser}'
                  adduser -c '' ${CodeEditorUser}
                  passwd -l ${CodeEditorUser}
                  echo "${CodeEditorUser}:{{ CodeEditorPassword }}" | chpasswd
                  usermod -aG wheel ${CodeEditorUser}
                  sed -i 's/# %wheel/%wheel/g' /etc/sudoers
                - echo "User added. Checking configuration"
                - !Sub getent passwd ${CodeEditorUser}
          - name: AddUserApt
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - ubuntu
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dpkg --configure -a
                - !Sub |
                  if [[ "${CodeEditorUser}" == "ubuntu" ]]
                  then
                    echo 'Using existing user: ${CodeEditorUser}'
                  else
                    echo 'Adding user: ${CodeEditorUser}'
                    adduser --disabled-password --gecos '' ${CodeEditorUser}
                    echo "${CodeEditorUser}:{{ CodeEditorPassword }}" | chpasswd
                    usermod -aG sudo ${CodeEditorUser}
                  fi
                - !Sub |
                  tee /etc/sudoers.d/91-vscode-user <<EOF
                  ${CodeEditorUser} ALL=(ALL) NOPASSWD:ALL
                  EOF
                - !Sub mkdir -p /home/${CodeEditorUser} && chown -R ${CodeEditorUser}:${CodeEditorUser} /home/${CodeEditorUser}
                - !Sub mkdir -p /home/${CodeEditorUser}/.local/bin && chown -R ${CodeEditorUser}:${CodeEditorUser} /home/${CodeEditorUser}
                - echo "User added. Checking configuration"
                - !Sub getent passwd ${CodeEditorUser}
          - name: UpdateProfile
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - echo LANG=en_US.utf-8 >> /etc/environment
                - echo LC_ALL=en_US.UTF-8 >> /etc/environment
                - !Sub echo 'PATH=$PATH:/home/${CodeEditorUser}/.local/bin' >> /home/${CodeEditorUser}/.bashrc
                - !Sub echo 'export PATH' >> /home/${CodeEditorUser}/.bashrc
                - !Sub echo 'export AWS_REGION=${AWS::Region}' >> /home/${CodeEditorUser}/.bashrc
                - !Sub echo 'export AWS_ACCOUNTID=${AWS::AccountId}' >> /home/${CodeEditorUser}/.bashrc
                - !Sub echo 'export NEXT_TELEMETRY_DISABLED=1' >> /home/${CodeEditorUser}/.bashrc
                - !Sub echo "export PS1='\[\033[01;32m\]\u:\[\033[01;34m\]\w\[\033[00m\]\$ '" >> /home/${CodeEditorUser}/.bashrc
                - !Sub chown -R ${CodeEditorUser}:${CodeEditorUser} /home/${CodeEditorUser}
          - name: InstallAWSCLI
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - set -euo pipefail
                - mkdir -p /tmp
                - curl -fsSL https://awscli.amazonaws.com/awscli-exe-linux-$(uname -m).zip -o /tmp/aws-cli.zip
                - !Sub chown -R ${CodeEditorUser}:${CodeEditorUser} /tmp/aws-cli.zip
                - unzip -q -d /tmp /tmp/aws-cli.zip
                - sudo /tmp/aws/install
                - rm -rf /tmp/aws
                - echo "AWS CLI installed. Checking configuration"
                - aws --version
          - name: InstallGitDnf
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - al2023
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - set -euo pipefail
                - dnf install -y git
                - !Sub sudo -u ${CodeEditorUser} git config --global user.email "participant@example.com"
                - !Sub sudo -u ${CodeEditorUser} git config --global user.name "Workshop Participant"
                - !Sub sudo -u ${CodeEditorUser} git config --global init.defaultBranch "main"
                - echo "Git installed. Checking configuration"
                - git --version
          - name: InstallGitApt
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - ubuntu
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - set -euo pipefail
                - dpkg --configure -a
                - add-apt-repository ppa:git-core/ppa
                - apt-get -q update && DEBIAN_FRONTEND=noninteractive apt-get install -y -q git
                - !Sub sudo -u ${CodeEditorUser} git config --global user.email "participant@example.com"
                - !Sub sudo -u ${CodeEditorUser} git config --global user.name "Workshop Participant"
                - !Sub sudo -u ${CodeEditorUser} git config --global init.defaultBranch "main"
                - echo "Git installed. Checking configuration"
                - git --version
          - name: CloneRepo
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 600
              runCommand:
                - '#!/bin/bash'
                - !Sub |
                  if [[ -z "${RepoUrl}" ]]
                  then
                    echo "No Repo"
                  else
                    mkdir -p ${HomeFolder} && chown -R ${CodeEditorUser}:${CodeEditorUser} ${HomeFolder}
                    sudo -u ${CodeEditorUser} git clone ${RepoUrl} ${HomeFolder}
                    echo "Repo ${RepoUrl} cloned. Checking configuration"
                    ls -la ${HomeFolder}
                    sudo -u ${CodeEditorUser} git -C ${HomeFolder} remote -v
                  fi
          - name: DownloadAssets
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 600
              runCommand:
                - '#!/bin/bash'
                - !Sub |
                  if [[ -z "${AssetZipS3Path}" ]]
                  then
                    echo "No assets"
                  else
                    mkdir -p ${HomeFolder} && chown -R ${CodeEditorUser}:${CodeEditorUser} ${HomeFolder}
                    mkdir -p /tmp
                    aws s3 cp s3://${AssetZipS3Path} /tmp/asset.zip
                    chown -R ${CodeEditorUser}:${CodeEditorUser} /tmp/asset.zip
                    unzip -o /tmp/asset.zip -d ${HomeFolder}
                    chown -R ${CodeEditorUser}:${CodeEditorUser} ${HomeFolder}
                    if  [[ -d ${HomeFolder}/.git ]] # Indicates that a repo has been cloned
                    then
                      sudo -u ${CodeEditorUser} git -C ${HomeFolder} add .
                      sudo -u ${CodeEditorUser} git -C ${HomeFolder} commit -m 'Workshop commit'
                    else
                      sudo -u ${CodeEditorUser} git -C ${HomeFolder} init
                      sudo -u ${CodeEditorUser} git -C ${HomeFolder} add .
                      sudo -u ${CodeEditorUser} git -C ${HomeFolder} commit -m 'Initial commit'
                    fi
                    echo "Assets downloaded. Checking configuration: ${HomeFolder}"
                    ls -la ${HomeFolder}
                    sudo -u ${CodeEditorUser} git -C ${HomeFolder} branch
                  fi
          - name: DownloadFolders
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 600
              runCommand:
                - '#!/bin/bash'
                - !Sub |
                  if [[ -z "${FolderZipS3Path}" ]]
                  then
                    echo "No folders"
                  else
                    rm -rf /tmp/folder
                    mkdir -p /tmp/folder && chown -R ${CodeEditorUser}:${CodeEditorUser} /tmp/folder
                    aws s3 cp s3://${FolderZipS3Path} /tmp/asset-folder.zip
                    chown -R ${CodeEditorUser}:${CodeEditorUser} /tmp/asset-folder.zip
                    unzip -o /tmp/asset-folder.zip -d /tmp/folder
                    chown -R ${CodeEditorUser}:${CodeEditorUser} /tmp/folder
                    mkdir -p ${HomeFolder} && chown -R ${CodeEditorUser}:${CodeEditorUser} ${HomeFolder}
                    cd "${HomeFolder}" && cd ..
                    if [[ $(pwd) ==  "/" ]]
                    then
                      targetRootFolder=""
                    else
                      targetRootFolder=$(pwd)
                      chown -R ${CodeEditorUser}:${CodeEditorUser} .
                    fi
                    find "/tmp/folder" -maxdepth 1 -mindepth 1 -type d | while read sourceFolder; do
                      folder="$(basename $sourceFolder)"
                      echo "Processing folder: $folder"
                      targetFolder=$targetRootFolder/$folder
                      if [[ $targetRootFolder == "" ]]
                      then
                        mv $sourceFolder /
                      else
                        mv $sourceFolder $targetRootFolder
                      fi
                      chown -R ${CodeEditorUser}:${CodeEditorUser} $targetFolder
                      sudo -u ${CodeEditorUser} git -C $targetFolder init
                      sudo -u ${CodeEditorUser} git -C $targetFolder add .
                      sudo -u ${CodeEditorUser} git -C $targetFolder commit -m "Initial commit"
                      echo "Folder downloaded. Checking configuration: $targetFolder"
                      ls -la $targetFolder
                    done
                    rm -rf /tmp/folder
                  fi
          - name: DownloadBranches
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 600
              runCommand:
                - '#!/bin/bash'
                - !Sub |
                  if [[ -z "${BranchZipS3Path}" ]]
                  then
                    echo "No branches"
                  else
                    rm -rf /tmp/branch
                    rm -rf /tmp/git
                    mkdir -p /tmp/branch && chown -R ${CodeEditorUser}:${CodeEditorUser} /tmp/branch
                    mkdir -p /tmp/git && chown -R ${CodeEditorUser}:${CodeEditorUser} /tmp/git
                    aws s3 cp s3://${BranchZipS3Path} /tmp/asset-branch.zip
                    chown -R ${CodeEditorUser}:${CodeEditorUser} /tmp/asset-branch.zip
                    unzip -o /tmp/asset-branch.zip -d /tmp/branch
                    chown -R ${CodeEditorUser}:${CodeEditorUser} /tmp/branch
                    mkdir -p ${HomeFolder} && chown -R ${CodeEditorUser}:${CodeEditorUser} ${HomeFolder}
                    sudo -u ${CodeEditorUser} git -C ${HomeFolder} init
                    mv ${HomeFolder}/.git /tmp/git
                    rm -rf ${HomeFolder}
                    mkdir -p ${HomeFolder} && chown -R ${CodeEditorUser}:${CodeEditorUser} ${HomeFolder}
                    mv /tmp/git/.git ${HomeFolder}
                    find /tmp/branch -maxdepth 1 -mindepth 1 -type d | while read sourceFolder; do
                      branch="$(basename $sourceFolder)"
                      echo "Processing branch: $branch"
                      sudo -u ${CodeEditorUser} git -C ${HomeFolder} checkout -b $branch 2>&1
                      cp -a $sourceFolder/. ${HomeFolder}
                      sudo -u ${CodeEditorUser} git -C ${HomeFolder} add .
                      sudo -u ${CodeEditorUser} git -C ${HomeFolder} commit -m "Initial commit $branch"
                      mv ${HomeFolder}/.git /tmp/git
                      rm -rf ${HomeFolder}
                      mkdir ${HomeFolder} && chown -R ${CodeEditorUser}:${CodeEditorUser} ${HomeFolder}
                      mv /tmp/git/.git ${HomeFolder}
                    done
                    sudo -u ${CodeEditorUser} git -C ${HomeFolder} checkout main 2>&1
                    sudo -u ${CodeEditorUser} git -C ${HomeFolder} restore .
                    rm -rf /tmp/branch
                    rm -rf /tmp/git
                    echo "Branches downloaded. Checking configuration: $HomeFolder"
                    sudo -u ${CodeEditorUser} git -C ${HomeFolder} branch
                    ls -la ${HomeFolder}
                  fi
          - name: InstallCodeEditor
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 600
              runCommand:
                - '#!/bin/bash'
                - set -euo pipefail
                - !Sub export CodeEditorUser=${CodeEditorUser}
                - curl -fsSL https://code-editor.amazonaws.com/content/code-editor-server/dist/aws-workshop-studio/install.sh | bash -s -- 2>&1 || { echo "QDesktop Editor installation failed"; exit 1; }
          - name: ConfigureCodeEditorForPrivateAccess
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 600
              runCommand:
                - '#!/bin/bash'
                - set -euo pipefail
                - echo "Configuring QDesktop Editor for private subnet access..."
                - !Sub |
                  # Modify QDesktop Editor service to bind to all interfaces instead of localhost only
                  sed -i 's/--host 127.0.0.1/--host 0.0.0.0/g' /usr/lib/systemd/system/code-editor@.service
                  systemctl daemon-reload
                - echo "QDesktop Editor configured for private access"
          - name: ConfigureAuthToken
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 600
              runCommand:
                - !Sub |
                  sudo -u ${CodeEditorUser} --login mkdir -p /home/${CodeEditorUser}/.code-editor-server/data
                  sudo -u ${CodeEditorUser} --login touch /home/${CodeEditorUser}/.code-editor-server/data/token
                  # token format: /^[0-9A-Za-z_-]+$/
                  echo -n "{{ CodeEditorPassword }}" > /home/${CodeEditorUser}/.code-editor-server/data/token
          - name: CreateCodeEditorSettings
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 600
              runCommand:
                - !Sub sudo -u ${CodeEditorUser} --login mkdir -p /home/${CodeEditorUser}/.code-editor-server/data/User
                - !Sub sudo -u ${CodeEditorUser} --login touch /home/${CodeEditorUser}/.code-editor-server/data/User/settings.json
                - !Sub touch /home/${CodeEditorUser}/.hushlogin
                - !Sub mkdir -p ${HomeFolder} && chown -R ${CodeEditorUser}:${CodeEditorUser} ${HomeFolder}
                - !Sub |
                  tee /home/${CodeEditorUser}/.code-editor-server/data/User/settings.json <<EOF
                  {
                    "aws.telemetry": false,
                    "extensions.autoUpdate": false,
                    "extensions.autoCheckUpdates": false,
                    "telemetry.telemetryLevel": "off",
                    "security.workspace.trust.startupPrompt": "never",
                    "security.workspace.trust.enabled": false,
                    "security.workspace.trust.banner": "never",
                    "security.workspace.trust.emptyWindow": false,
                    "workbench.startupEditor": "none",
                    "terminal.integrated.cwd": "${HomeFolder}",
                    "auto-run-command.rules": [
                      {
                        "command": "workbench.action.terminal.new"
                      }
                    ]
                  }
                  EOF
                - !Sub chown -R ${CodeEditorUser}:${CodeEditorUser} /home/${CodeEditorUser}
                - !Sub systemctl enable --now code-editor@${CodeEditorUser}
                - !Sub systemctl restart code-editor@${CodeEditorUser}
          - name: InstallCodeEditorExtensions
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 600
              runCommand:
                - '#!/bin/bash'
                - set -euo pipefail
                - !Sub |
                  function install_extension() {
                    local extension_name=$1
                    echo "Installing extension: $extension_name"
                    if ! sudo -u ${CodeEditorUser} --login code-editor-server --install-extension "$extension_name" --force; then
                        echo "Failed to install $extension_name"
                        return 1
                    fi

                    if sudo -u ${CodeEditorUser} --login code-editor-server --list-extensions | grep -qi "$extension_name"; then
                        echo "Successfully installed $extension_name"
                    else
                        echo "Extension $extension_name not found in installed list"
                        return 1
                    fi
                    return 0
                  }
                  install_extension "AmazonWebServices.aws-toolkit-vscode" || exit 1
                  install_extension "AmazonWebServices.amazon-q-vscode" || exit 1
                  install_extension "ms-vscode.live-server" || exit 1
                  install_extension "synedra.auto-run-command" || exit 1
                - !Sub chown -R ${CodeEditorUser}:${CodeEditorUser} /home/${CodeEditorUser}
                - echo "QDesktop Editor installed. Checking configuration"
                - !Sub sudo -u ${CodeEditorUser} --login code-editor-server -v
                - !Sub systemctl status code-editor@${CodeEditorUser}
          - name: InstallNodeDnf
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - al2023
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - set -euo pipefail
                - dnf install -y nodejs npm
                - echo "Node and npm installed. Checking configuration"
                - node -v
                - npm -v
          - name: InstallNodeApt
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - ubuntu
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - set -euo pipefail
                - curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /usr/share/keyrings/nodesource.gpg
                - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_22.x nodistro main" > /etc/apt/sources.list.d/nodesource.list
                - apt-get -q update && DEBIAN_FRONTEND=noninteractive apt-get install -y -q nodejs
                - npm install -g npm@latest
                - echo "Node and npm installed. Checking configuration"
                - node -v
                - npm -v
          - name: InstallCDK
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - npm install -g aws-cdk
                - echo "AWS CDK installed. Checking configuration"
                - cdk --version
          - name: InstallQCLI
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - curl --proto '=https' --tlsv1.2 -sSf "https://desktop-release.q.us-east-1.amazonaws.com/latest/q-$(uname -m)-linux.zip" -o /tmp/q.zip
                - !Sub chown -R ${CodeEditorUser}:${CodeEditorUser} /tmp/q.zip
                - unzip -q -d /tmp /tmp/q.zip
                - !Sub chown -R ${CodeEditorUser}:${CodeEditorUser} /tmp/q
                - chmod +x /tmp/q/install.sh
                - !Sub sudo -u ${CodeEditorUser} /tmp/q/install.sh --no-confirm
                - rm -rf /tmp/q
                - echo "Amazon Q CLI installed"
          - name: Installuv
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 600
              runCommand:
                - '#!/bin/bash'
                - !Sub sudo -u ${CodeEditorUser} --login curl -fsSL https://astral.sh/uv/install.sh -o /tmp/uv_install.sh
                - !Sub sudo -u ${CodeEditorUser} --login bash /tmp/uv_install.sh
                - !Sub |
                    if uv generate-shell-completion bash &>/dev/null; then
                      echo 'eval "$(uv generate-shell-completion bash)"' >> /home/${CodeEditorUser}/.bashrc
                    fi
                - !Sub |
                    if uvx generate-shell-completion bash &>/dev/null; then
                      echo 'eval "$(uvx generate-shell-completion bash)"' >> /home/${CodeEditorUser}/.bashrc
                    fi
                - echo "uv installed. Checking configuration"
                - !Sub sudo -u ${CodeEditorUser} --login uv --version
          - name: InstallPythonDnf
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - al2023
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dnf install -y python3.11 python3.11-pip python3-virtualenv python3-pytest python3-boto3
                - !Sub echo 'alias pytest=pytest-3' >> /home/${CodeEditorUser}/.bashrc
                - !Sub echo 'alias python3=python3.11' >> /home/${CodeEditorUser}/.bashrc
                - !Sub echo 'alias pip3=pip3.11' >> /home/${CodeEditorUser}/.bashrc
                - echo 'alias=python3=python3.11' >> ~/.bashrc
                - echo 'alias pip3=pip3.11' >> ~/.bashrc
                - python3.11 -m pip install --upgrade pip 2>&1
                - !Sub |
                    if ! sudo -u ${CodeEditorUser} --login code-editor-server --install-extension ms-python.python --force; then
                        echo "Failed to install ms-python.python"
                        return 1
                    fi
                - !Sub |
                    if [ -f /home/${CodeEditorUser}/.code-editor-server/data/User/settings.json ]; then
                      sed -i "2i\\  \"python.testing.pytestEnabled\": true," /home/${CodeEditorUser}/.code-editor-server/data/User/settings.json
                    else
                      echo '{
                        "python.testing.pytestEnabled": true
                      }' > /home/${CodeEditorUser}/.code-editor-server/data/User/settings.json
                    fi
                - echo "Python and Pip installed. Checking configuration"
                - python3.11 --version
                - python3.11 -m pip --version 2>&1
          - name: InstallPythonApt
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - ubuntu
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dpkg --configure -a
                - apt-get -q update && DEBIAN_FRONTEND=noninteractive apt-get install -y -q python3-pip python3-venv python3-boto3 python3-pytest
                - !Sub echo 'alias pytest=pytest-3' >> /home/${CodeEditorUser}/.bashrc
                - systemctl start multipathd.service packagekit.service
                - systemctl restart unattended-upgrades.service
                - systemctl restart networkd-dispatcher.service
                - !Sub |
                    if ! sudo -u ${CodeEditorUser} --login code-editor-server --install-extension ms-python.python --force; then
                        echo "Failed to install ms-python.python"
                        return 1
                    fi
                - !Sub |
                    if [ -f /home/${CodeEditorUser}/.code-editor-server/data/User/settings.json ]; then
                      sed -i "2i\\  \"python.testing.pytestEnabled\": true," /home/${CodeEditorUser}/.code-editor-server/data/User/settings.json
                    else
                      echo '{
                        "python.testing.pytestEnabled": true
                      }' > /home/${CodeEditorUser}/.code-editor-server/data/User/settings.json
                    fi
                - echo "Python and Pip installed. Checking configuration"
                - python3 --version
                - pip3 --version
          - name: InstallJavaDnf
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - al2023
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dnf install -y java-21-amazon-corretto java-17-amazon-corretto java-1.8.0-amazon-corretto maven
                - !Sub echo 'export JAVA_1_8_HOME=$(dirname $(dirname $(readlink -f $(which java))))' >> /home/${CodeEditorUser}/.bashrc
                - !Sub echo 'export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))' >> /home/${CodeEditorUser}/.bashrc
                - !Sub echo 'export PATH=$PATH:$JAVA_HOME/bin:/usr/share/maven/bin' >> /home/${CodeEditorUser}/.bashrc
                - !Sub |
                    if ! sudo -u ${CodeEditorUser} --login code-editor-server --install-extension vscjava.vscode-java-pack --force; then
                        echo "Failed to install vscjava.vscode-java-pack"
                        return 1
                    fi
                - echo "Java and Maven installed. Checking configuration"
                - java -version 2>&1
                - mvn --version
                - update-alternatives --display java
          - name: InstallJavaApt
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - ubuntu
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dpkg --configure -a
                - curl -fsSL https://apt.corretto.aws/corretto.key | gpg --dearmor -o /usr/share/keyrings/corretto-keyring.gpg
                - echo "deb [signed-by=/usr/share/keyrings/corretto-keyring.gpg] https://apt.corretto.aws stable main" > /etc/apt/sources.list.d/corretto.list
                - DEBIAN_FRONTEND=noninteractive apt-get update
                - DEBIAN_FRONTEND=noninteractive apt-get install -y -q java-21-amazon-corretto-jdk java-17-amazon-corretto-jdk java-1.8.0-amazon-corretto-jdk maven
                - !Sub echo 'export JAVA_1_8_HOME=$(dirname $(dirname $(readlink -f $(which java))))' >> /home/${CodeEditorUser}/.bashrc
                - !Sub echo 'export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))' >> /home/${CodeEditorUser}/.bashrc
                - !Sub echo 'export PATH=$PATH:$JAVA_HOME/bin:/usr/share/maven/bin' >> /home/${CodeEditorUser}/.bashrc
                - !Sub |
                    if ! sudo -u ${CodeEditorUser} --login code-editor-server --install-extension vscjava.vscode-java-pack --force; then
                        echo "Failed to install vscjava.vscode-java-pack"
                        return 1
                    fi
                - echo "Java and Maven installed. Checking configuration"
                - java -version 2>&1
                - mvn --version
                - update-alternatives --list java
          - name: InstallGoDnf
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - al2023
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dnf install -y golang
                - !Sub chown -R ${CodeEditorUser}:${CodeEditorUser} /home/${CodeEditorUser}
                - echo "Go installed. Checking configuration"
                - go version
          - name: InstallGoApt
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - ubuntu
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dpkg --configure -a
                - add-apt-repository ppa:longsleep/golang-backports
                - apt-get -q update && DEBIAN_FRONTEND=noninteractive apt-get install -y -q golang-go
                - !Sub chown -R ${CodeEditorUser}:${CodeEditorUser} /home/${CodeEditorUser}
                - echo "Go installed. Checking configuration"
                - go version
          - name: InstallDotnetDnf
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - al2023
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dnf install -y dotnet-sdk-8.0
                - dotnet tool install -g Microsoft.Web.LibraryManager.Cli
                - !Sub echo 'PATH=$PATH:/home/${CodeEditorUser}/.dotnet/tools' >> /home/${CodeEditorUser}/.bashrc
                - !Sub chown -R ${CodeEditorUser}:${CodeEditorUser} /home/${CodeEditorUser}
                - echo "Dotnet installed. Checking configuration"
                - dotnet --list-sdks
          - name: InstallDotnetApt
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - ubuntu
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dpkg --configure -a
                - apt-get -q update && DEBIAN_FRONTEND=noninteractive apt-get install -y -q dotnet-sdk-8.0
                - dotnet tool install -g Microsoft.Web.LibraryManager.Cli
                - !Sub echo 'PATH=$PATH:/home/${CodeEditorUser}/.dotnet/tools' >> /home/${CodeEditorUser}/.bashrc
                - !Sub chown -R ${CodeEditorUser}:${CodeEditorUser} /home/${CodeEditorUser}
                - echo "Dotnet installed. Checking configuration"
                - dotnet --list-sdks
          - name: InstallRust
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - !Sub sudo -u ${CodeEditorUser} --login curl -fsSL https://sh.rustup.rs -o /tmp/rust_install.sh
                - !Sub sudo -u ${CodeEditorUser} --login bash /tmp/rust_install.sh -y 2>&1
                - echo "Rust installed. Checking configuration"
                - !Sub sudo -u ${CodeEditorUser} --login rustc --version
          - name: InstallVite
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - npm install -g create-vite
                - echo "Vite installed. Checking configuration"
                - create-vite -h
          - name: InstallDockerDnf
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - al2023
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dnf install -y docker
                - !Sub usermod -aG docker ${CodeEditorUser}
                - !Sub sudo -u ${CodeEditorUser} newgrp docker
                - !Sub systemctl restart code-editor@${CodeEditorUser}
                - systemctl start docker.service
                - !Sub |
                    if ! sudo -u ${CodeEditorUser} --login code-editor-server --install-extension ms-azuretools.vscode-docker --force; then
                        echo "Failed to install ms-azuretools.vscode-docker"
                        return 1
                    fi
                - echo "Docker installed. Checking configuration"
                - docker --version
                - systemctl status docker.service
          - name: InstallDockerApt
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - ubuntu
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dpkg --configure -a
                - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
                - echo "deb [signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release --codename --short) stable" > /etc/apt/sources.list.d/docker.list
                - apt-get -q update && DEBIAN_FRONTEND=noninteractive apt-get install -y -q docker-ce docker-ce-cli containerd.io
                - !Sub usermod -aG docker ${CodeEditorUser}
                - !Sub sudo -u ${CodeEditorUser} newgrp docker
                - !Sub systemctl restart code-editor@${CodeEditorUser}                
                - systemctl start docker.service
                - !Sub |
                    if ! sudo -u ${CodeEditorUser} --login code-editor-server --install-extension ms-azuretools.vscode-docker --force; then
                        echo "Failed to install ms-azuretools.vscode-docker"
                        return 1
                    fi
                - echo "Docker installed. Checking configuration"
                - docker --version
                - systemctl status docker.service
          - name: InstallTerraformDnf
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - al2023
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dnf config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo
                - dnf -y install terraform 2>&1
                - echo "Terraform installed. Checking configuration"
                - terraform --version
          - name: InstallTerraformApt
            action: aws:runShellScript
            precondition:
              StringEquals:
                - '{{ LinuxFlavor }}'
                - ubuntu
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dpkg --configure -a
                - curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-keyring.gpg
                - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-keyring.gpg] https://apt.releases.hashicorp.com/ $(lsb_release --codename --short) main" >> /etc/apt/sources.list.d/hashicorp.list
                - apt-get -q update && DEBIAN_FRONTEND=noninteractive apt-get install -y -q terraform
                - echo "Terraform installed. Checking configuration"
                - terraform --version
          - name: PrivateSubnetHealthCheck
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - set -euo pipefail
                - echo "=== Private Subnet QDesktop Editor Health Check ==="
                - !Sub |
                  # Wait for QDesktop Editor to be fully ready
                  for i in {1..30}; do
                    if curl -s http://localhost:8080/healthz >/dev/null 2>&1; then
                      echo "✅ QDesktop Editor health check passed"
                      break
                    fi
                    echo "Waiting for QDesktop Editor to be ready... ($i/30)"
                    sleep 2
                  done
                  
                  # Verify network binding
                  echo "=== Network Binding Verification ==="
                  BINDING=$(netstat -tlnp | grep :8080 | grep -o "0.0.0.0:8080\|127.0.0.1:8080")
                  if [[ "$BINDING" == "0.0.0.0:8080" ]]; then
                    echo "✅ Network binding: $BINDING (External access enabled)"
                  else
                    echo "❌ Network binding: $BINDING (External access disabled)"
                    echo "Fixing network binding..."
                    systemctl stop code-editor@${CodeEditorUser}
                    sed -i 's/--host 127.0.0.1/--host 0.0.0.0/g' /usr/lib/systemd/system/code-editor@.service
                    systemctl daemon-reload
                    systemctl start code-editor@${CodeEditorUser}
                    sleep 5
                    BINDING_FIXED=$(netstat -tlnp | grep :8080 | grep -o "0.0.0.0:8080\|127.0.0.1:8080")
                    echo "✅ Network binding fixed: $BINDING_FIXED"
                  fi
                  
                  # Final status report
                  echo "=== Final Status Report ==="
                  systemctl is-active code-editor@${CodeEditorUser} && echo "Service: ✅ Active" || echo "Service: ❌ Inactive"
                  netstat -tlnp | grep :8080 && echo "Port 8080: ✅ Listening" || echo "Port 8080: ❌ Not listening"
                  curl -s -o /dev/null -w "Health endpoint: %{http_code}\n" http://localhost:8080/healthz
                  
                  echo "Private subnet QDesktop Editor deployment complete!"
                  echo "Access URL: http://$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4):8080/?folder=${HomeFolder}&tkn={{ CodeEditorPassword }}"
  SSMDocLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: !Sub lambda.${AWS::URLSuffix}
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Sub arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SSMDocOnEC2
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - ssm:SendCommand
                Resource:
                  - !Sub arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:document/${CodeEditorSSMDoc}
                  - !Sub arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:document/AmazonCloudWatch-ManageAgent
                  - !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:instance/${CodeEditorInstance}
              - Effect: Allow
                Action:
                  - ssm:ListCommandInvocations
                  - ssm:GetCommandInvocation
                Resource: '*'

  RunSSMDocLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: Run SSM document on EC2 instance
      Handler: index.lambda_handler
      Runtime: python3.13
      MemorySize: 128
      Timeout: 600
      Environment:
        Variables:
          RetrySleep: 2900
          AbortTimeRemaining: 3200
      Architectures:
        - arm64
      Role: !GetAtt SSMDocLambdaRole.Arn
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          import logging
          import time
          import os

          logger = logging.getLogger()
          logger.setLevel(logging.INFO)

          def lambda_handler(event, context):
              logger.debug(f'event: {event}')
              logger.debug(f'context: {context}')

              if event['RequestType'] != 'Create':
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData={}, reason='No action to take')
              else:
                  sleep_ms = int(os.environ.get('RetrySleep'))
                  abort_time_remaining_ms = int(os.environ.get('AbortTimeRemaining'))
                  resource_properties = event['ResourceProperties']
                  instance_id = resource_properties['InstanceId']
                  document_name = resource_properties['DocumentName']
                  cloudwatch_log_group_name = resource_properties['CloudWatchLogGroupName']

                  logger.info(f'Running SSM Document {document_name} on EC2 instance {instance_id}. Logging to {cloudwatch_log_group_name}')

                  del resource_properties['ServiceToken']
                  if 'ServiceTimeout' in resource_properties:
                      del resource_properties['ServiceTimeout']
                  del resource_properties['InstanceId']
                  del resource_properties['DocumentName']
                  del resource_properties['CloudWatchLogGroupName']
                  if 'PhysicalResourceId' in resource_properties:
                      del resource_properties['PhysicalResourceId']

                  logger.debug(f'resource_properties filtered: {resource_properties}')

                  parameters = {}
                  for key, value in resource_properties.items():
                      parameters[key] = [value]

                  logger.debug(f'parameters: {parameters}')

                  retry = True
                  attempt_no = 0
                  time_remaining_ms = context.get_remaining_time_in_millis()

                  ssm = boto3.client('ssm')

                  while (retry == True):
                      attempt_no += 1
                      logger.info(f'Attempt: {attempt_no}. Time Remaining: {time_remaining_ms/1000}s')
                      try:
                          response = ssm.send_command(
                              InstanceIds = [instance_id],
                              DocumentName = document_name,
                              CloudWatchOutputConfig = {'CloudWatchLogGroupName': cloudwatch_log_group_name, 'CloudWatchOutputEnabled': True},
                              Parameters = parameters
                          )
                          logger.debug(f'response: {response}')
                          command_id = response['Command']['CommandId']
                          responseData = {'CommandId': command_id}
                          cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, reason='OK')
                          retry = False

                      except ssm.exceptions.InvalidInstanceId as e:
                          time_remaining_ms = context.get_remaining_time_in_millis()
                          if (time_remaining_ms > abort_time_remaining_ms):
                              logger.info(f'Instance {instance_id} not ready. Sleeping: {sleep_ms/1000}s')
                              time.sleep(sleep_ms/1000)
                              retry = True
                          else:
                              logger.info(f'Instance {instance_id} not ready, timed out. Time remaining {time_remaining_ms/1000}s < Abort time remaining {abort_time_remaining_ms/1000}s')
                              logger.error(e, exc_info=True)
                              cfnresponse.send(event, context, cfnresponse.FAILED, responseData={}, reason='Timed out. Time remaining: ' + str(time_remaining_ms/1000) + 's < Abort time remaining: ' + str(abort_time_remaining_ms/1000) + 's')
                              retry = False

                      except Exception as e:
                          logger.error(e, exc_info=True)
                          cfnresponse.send(event, context, cfnresponse.FAILED, responseData={}, reason=str(e))
                          retry = False

  RunCodeEditorSSMDoc:
    Type: Custom::RunSSMDocLambda
    Properties:
      ServiceToken: !GetAtt RunSSMDocLambda.Arn
      ServiceTimeout: 305
      InstanceId: !Ref CodeEditorInstance
      DocumentName: !Ref CodeEditorSSMDoc
      CloudWatchLogGroupName: !Sub /aws/ssm/${CodeEditorSSMDoc}
      CodeEditorPassword: !GetAtt SecretPlaintext.password
      LinuxFlavor: !If [IsAL2023, 'al2023', 'ubuntu']

  CodeEditorInstanceBootstrapRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - !Sub ec2.${AWS::URLSuffix}
                - !Sub ssm.${AWS::URLSuffix}
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Sub arn:${AWS::Partition}:iam::aws:policy/AmazonSSMManagedInstanceCore
        - !Sub arn:${AWS::Partition}:iam::aws:policy/CloudWatchAgentServerPolicy
        - !Sub arn:${AWS::Partition}:iam::aws:policy/AmazonQDeveloperAccess
        - !Sub arn:${AWS::Partition}:iam::aws:policy/ReadOnlyAccess
      Policies:
        - PolicyName: S3AssetAccess
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: 
                  - !Sub "arn:${AWS::Partition}:s3:::*/*"

  CodeEditorInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref CodeEditorInstanceBootstrapRole

  CodeEditorInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !If
        - IsGraviton
        - !FindInMap [ArmImage, !Ref InstanceOperatingSystem, ImageId]
        - !FindInMap [AmdImage, !Ref InstanceOperatingSystem, ImageId]
      InstanceType: !Ref InstanceType
      SubnetId: !Ref PrivateSubnetId
      BlockDeviceMappings:
        - DeviceName: !If [IsAL2023, /dev/xvda, /dev/sda1]
          Ebs:
            VolumeSize: !Ref InstanceVolumeSize
            VolumeType: gp3
            DeleteOnTermination: true
            Encrypted: true
      Monitoring: true
      SecurityGroupIds:
        - !Ref SecurityGroup
      IamInstanceProfile: !Ref CodeEditorInstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #cloud-config
          hostname: ${InstanceName}
          runcmd:
            - mkdir -p ${HomeFolder} && chown -R ${CodeEditorUser}:${CodeEditorUser} ${HomeFolder}
      Tags:
      - Key: Name
        Value: !Ref InstanceName
      - Key: Environment
        Value: Development
      - Key: Application
        Value: QDesktopEditor-Privatesubnet-Enhanced

  CheckSSMDocLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: Check SSM document on EC2 instance
      Handler: index.lambda_handler
      Runtime: python3.13
      MemorySize: 128
      Timeout: 600
      Environment:
        Variables:
          RetrySleep: 2900
          AbortTimeRemaining: 5000
      Architectures:
        - arm64
      Role: !GetAtt SSMDocLambdaRole.Arn
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          import logging
          import time
          import os

          logger = logging.getLogger()
          logger.setLevel(logging.INFO)

          def lambda_handler(event, context):
              logger.debug(f'event: {event}')
              logger.debug(f'context: {context}')

              if event['RequestType'] != 'Create':
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData={}, reason='No action to take')
              else:
                  sleep_ms = int(os.environ.get('RetrySleep'))
                  abort_time_remaining_ms = int(os.environ.get('AbortTimeRemaining'))
                  resource_properties = event['ResourceProperties']
                  instance_id = resource_properties['InstanceId']
                  document_name = resource_properties['DocumentName']

                  logger.info(f'Checking SSM Document {document_name} on EC2 instance {instance_id}')

                  retry = True
                  attempt_no = 0
                  time_remaining_ms = context.get_remaining_time_in_millis()

                  ssm = boto3.client('ssm')

                  while (retry == True):
                      attempt_no += 1
                      logger.info(f'Attempt: {attempt_no}. Time Remaining: {time_remaining_ms/1000}s')
                      try:
                          response = ssm.list_command_invocations(
                              InstanceId=instance_id,
                              Details=True
                          )
                          logger.debug(f'Response: {response}')
                          for invocation in response['CommandInvocations']:
                              if invocation['DocumentName'] == document_name:
                                  invocation_status = invocation['Status']
                                  if invocation_status == 'Success':
                                      logger.info(f'SSM Document {document_name} on EC2 instance {instance_id} complete. Status: {invocation_status}')                                  
                                      cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData={}, reason='OK')
                                      retry = False
                                  elif invocation_status == 'Failed' or invocation_status == 'Cancelled' or invocation_status == 'TimedOut':
                                      logger.info(f'SSM Document {document_name} on EC2 instance {instance_id} failed. Status: {invocation_status}')
                                      reason = ''
                                      for step in invocation['CommandPlugins']:
                                          step_name = step['Name']
                                          step_status = step['Status']
                                          step_output = step['Output']
                                          logger.debug(f'Step {step_name} {step_status}: {step_output}')
                                          if step_status != 'Success':
                                              try:
                                                  response_step = ssm.get_command_invocation(
                                                      CommandId=invocation['CommandId'],
                                                      InstanceId=instance_id,
                                                      PluginName=step_name
                                                  )
                                                  logger.debug(f'Step details: {response_step}')
                                                  step_output = response_step['StandardErrorContent']
                                              except Exception as e:
                                                  logger.error(e, exc_info=True)
                                              logger.info(f'Step {step_name} {step_status}: {step_output}')
                                              if reason == '':
                                                  reason = f'Step {step_name} {step_status}: {step_output}'
                                              else:
                                                  reason += f'\nStep {step_name} {step_status}: {step_output}'
                                      if reason == '':
                                          reason = f'SSM Document {document_name} on EC2 instance {instance_id} failed. Status: {invocation_status}'
                                      logger.info(f'{reason}')
                                      cfnresponse.send(event, context, cfnresponse.FAILED, responseData={}, reason=reason)
                                      retry = False
                                  else:
                                      logger.info(f'SSM Document {document_name} on EC2 instance {instance_id} not yet complete. Status: {invocation_status}')
                                      retry = True
                          if retry == True:
                              if (time_remaining_ms > abort_time_remaining_ms):
                                  logger.info(f'Sleeping: {sleep_ms/1000}s')
                                  time.sleep(sleep_ms/1000)
                                  time_remaining_ms = context.get_remaining_time_in_millis()
                              else:
                                  logger.info(f'Time remaining {time_remaining_ms/1000}s < Abort time remaining {abort_time_remaining_ms/1000}s')
                                  logger.info(f'Aborting check as time remaining {time_remaining_ms/1000}s < Abort time remaining {abort_time_remaining_ms/1000}s')
                                  cfnresponse.send(event, context, cfnresponse.FAILED, responseData={}, reason='Timed out. Time remaining: ' + str(time_remaining_ms/1000) + 's < Abort time remaining: ' + str(abort_time_remaining_ms/1000) + 's')
                                  retry = False
                      except Exception as e:
                          logger.error(e, exc_info=True)
                          cfnresponse.send(event, context, cfnresponse.FAILED, responseData={}, reason=str(e))
                          retry = False

  CheckCodeEditorSSMDoc:
    Type: Custom::CheckSSMDocLambda
    Properties:   
      ServiceToken: !GetAtt CheckSSMDocLambda.Arn
      ServiceTimeout: 610
      InstanceId: !Ref CodeEditorInstance
      DocumentName: !Ref CodeEditorSSMDoc
Outputs:
  PrivateIP:
    Description: EC2 Instance Private IP Address
    Value: !GetAtt CodeEditorInstance.PrivateIp
    Export:
      Name: !Sub ${AWS::StackName}-PrivateIP
      
  CodeEditorURL:
    Description: QDesktop Editor URL (accessible from within VPC only) - Replace TOKEN with actual password from secret
    Value: !Sub http://${CodeEditorInstance.PrivateIp}:8080/?folder=${HomeFolder}&tkn=${SecretPlaintext.password}
    Export:
      Name: !Sub ${AWS::StackName}-CodeEditorURL
      
  DevServerURL:
    Description: Development Server URL (if applicable)
    Value: !Sub http://${CodeEditorInstance.PrivateIp}:${DevServerPort}/${DevServerBasePath}
    Export:
      Name: !Sub ${AWS::StackName}-DevServerURL
      
  VPCId:
    Description: VPC ID used for deployment
    Value: !Ref VpcId
    
  PrivateSubnetId:
    Description: Private Subnet ID used for EC2 instance
    Value: !Ref PrivateSubnetId
    
  VpcCidr:
    Description: VPC CIDR used for security group rules
    Value: !Ref VpcCidr
    
  SecurityGroupId:
    Description: Security Group ID for the instance
    Value: !Ref SecurityGroup
    Export:
      Name: !Sub ${AWS::StackName}-SecurityGroupId
    
  InstanceId:
    Description: EC2 Instance ID
    Value: !Ref CodeEditorInstance
    Export:
      Name: !Sub ${AWS::StackName}-InstanceId
      
  SecretArn:
    Description: ARN of the secret containing QDesktop Editor credentials
    Value: !Ref CodeEditorSecret
    Export:
      Name: !Sub ${AWS::StackName}-SecretArn

  AccessInstructions:
    Description: How to access the QDesktop Editor in private subnet
    Value: !Sub |
      🔐 Access Methods:
      1. Session Manager: aws ssm start-session --target ${CodeEditorInstance}
      2. Direct URL: http://${CodeEditorInstance.PrivateIp}:8080/?folder=${HomeFolder}&tkn=${SecretPlaintext.password}
      3. From bastion host or VPN connection within VPC
      
      📋 Deployment Details:
      - Instance ID: ${CodeEditorInstance}
      - Private IP: ${CodeEditorInstance.PrivateIp}
      - VPC: ${VpcId}
      - Subnet: ${PrivateSubnetId}
      - Security Group: ${SecurityGroup}

  FullFeaturesIncluded:
    Description: Complete list of features preserved from original template
    Value: |
      ✅ ALL ORIGINAL FEATURES PRESERVED:
      🔧 Development Tools: Node.js, Python, Java, Go, .NET, Rust, Docker, Terraform
      🎨 VS Code Extensions: AWS Toolkit, Amazon Q, Live Server, Auto Run Command, Python, Java Pack, Docker
      📁 Asset Management: S3 downloads, folder management, branch management
      🔄 Git Support: Full repository cloning, branching, and version control
      👤 User Management: Complete user setup with sudo privileges
      📊 Monitoring: CloudWatch Agent, SSM integration, health checks
      🔐 Security: Secrets Manager, IAM roles, encrypted storage
      🌐 Network: Private subnet deployment, VPC-only access
      🚀 Automation: Complete SSM document automation, Lambda-based orchestration

  DeploymentCommand:
    Description: CloudFormation deployment command
    Value: !Sub |
      aws cloudformation create-stack \
        --stack-name code-editor-private-full \
        --template-body file://code-editor-private-full-features.yaml \
        --parameters \
          ParameterKey=VpcId,ParameterValue=${VpcId} \
          ParameterKey=PrivateSubnetId,ParameterValue=${PrivateSubnetId} \
          ParameterKey=VpcCidr,ParameterValue=${VpcCidr} \
        --capabilities CAPABILITY_IAM
